<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="paw5zx">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://paw5zx.github.io/sick-ranger3-source-code-analysis-01/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="简单分析Ranger3源码断线重连的实现">
<meta property="og:type" content="article">
<meta property="og:title" content="SICK Ranger3源码分析——断线重连">
<meta property="og:url" content="http://paw5zx.github.io/SICK-Ranger3-source-code-analysis-01/index.html">
<meta property="og:site_name" content="Paw5zx">
<meta property="og:description" content="简单分析Ranger3源码断线重连的实现">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-03-08T16:19:32.000Z">
<meta property="article:modified_time" content="2025-05-26T03:16:38.123Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/logos/O7_allmode.svg" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/logos/O7_allmode.svg">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/logos/O7_allmode.svg">
    <!--- Page Info-->
    
    <title>
        
            SICK Ranger3源码分析——断线重连 | Paw5zx
        
    </title>

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">


    <!--- Inject Part-->
    

    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/assets/build/styles.css">

    

    
<link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css">

    
<link rel="stylesheet" href="/fonts/Geist/geist.css">

    <!--- Font Part-->
    
    
    
    
    
    
        
<script src="/js/libs/anime.min.js"></script>

    

    <script id="hexo-configurations">
    window.config = {"hostname":"paw5zx.github.io","root":"/","language":"zh-CN","path":"search.xml"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":true,"link_icon":true,"title_alignment":"left","headings_top_spacing":{"h1":"3.2rem","h2":"2.4rem","h3":"1.9rem","h4":"1.6rem","h5":"1.4rem","h6":"1.3rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","highlight_theme":{"light":"github","dark":"vs2015"},"font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":4,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"recommendation":{"enable":true,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]},"pangu_js":false},"colors":{"primary":"#A31F34","secondary":null,"default_mode":"dark"},"global":{"fonts":{"chinese":{"enable":false,"family":"WenQuanYi Zen Hei Mono","url":"https://example.com/path/to/your/font.css"},"english":{"enable":false,"family":"Cutive Mono","url":"https://fonts.googleapis.com/css2?family=Cutive+Mono&display=swap"},"title":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":true,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":{"enable":true,"custom_message":"Paw5zx's Blog"},"open_graph":true,"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title":"Paw5zx's Blog","subtitle":{"text":["C++爱好者","APEX低手","精通中华田园敏捷开发"],"hitokoto":{"enable":false,"show_author":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":true,"style":"center","links":{"github":"https://github.com/paw5zx","instagram":null,"zhihu":null,"twitter":null,"email":null,"bilibili":"https://space.bilibili.com/11411875"},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.7.2","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Categories":{"path":"/categories","icon":"fa-regular fa-folder"},"Links":{"icon":"fa-regular fa-link","submenus":{"Itanium C++ ABI":"https://itanium-cxx-abi.github.io/cxx-abi/","C++ Standard Draft":"https://eel.is/c++draft/","Compiler Explorer":"https://gcc.godbolt.org/"}},"Archives":{"path":"/archives","icon":"fa-regular fa-archive"}},"search":{"enable":true,"preload":true}},"page_templates":{"friends_column":4,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"info","announcement":null,"show_on_mobile":true,"links":null},"article_date_format":"auto","excerpt_length":200,"categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2024/8/11 23:23:23"};
    window.lang_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
<!--        <span class="swup-progress-icon">-->
<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
<!--        </span>-->
    
</div>



    <style>
    :root {
        --preloader-background-color: #fff;
        --preloader-text-color: #000;
    }

    @media (prefers-color-scheme: dark) {
        :root {
            --preloader-background-color: #202124;
            --preloader-text-color: #fff;
        }
    }

    @media (prefers-color-scheme: light) {
        :root {
            --preloader-background-color: #fff;
            --preloader-text-color: #000;
        }
    }

    @media (max-width: 600px) {
        .ml13 {
            font-size: 2.6rem !important; /* Adjust this value as needed */
        }
    }

    .preloader {
        display: flex;
        flex-direction: column;
        gap: 1rem; /* Tailwind 'gap-4' is 1rem */
        align-items: center;
        justify-content: center;
        position: fixed;
        padding: 12px;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        width: 100vw;
        height: 100vh; /* 'h-screen' is 100% of the viewport height */
        background-color: var(--preloader-background-color);
        z-index: 1100; /* 'z-[1100]' sets the z-index */
        transition: opacity 0.2s ease-in-out;
    }

    .ml13 {
        font-size: 3.2rem;
        /* text-transform: uppercase; */
        color: var(--preloader-text-color);
        letter-spacing: -1px;
        font-weight: 500;
        font-family: 'Chillax-Variable', sans-serif;
        text-align: center;
    }

    .ml13 .word {
        display: inline-flex;
        flex-wrap: wrap;
        white-space: nowrap;
    }

    .ml13 .letter {
        display: inline-block;
        line-height: 1em;
    }
</style>

<div class="preloader">
    <h2 class="ml13">
        Paw5zx&#39;s Blog
    </h2>
    <script>
        var textWrapper = document.querySelector('.ml13');
        // Split text into words
        var words = textWrapper.textContent.trim().split(' ');

        // Clear the existing content
        textWrapper.innerHTML = '';

        // Wrap each word and its letters in spans
        words.forEach(function(word) {
            var wordSpan = document.createElement('span');
            wordSpan.classList.add('word');
            wordSpan.innerHTML = word.replace(/\S/g, "<span class='letter'>$&</span>");
            textWrapper.appendChild(wordSpan);
            textWrapper.appendChild(document.createTextNode(' ')); // Add space between words
        });

        var animation = anime.timeline({ loop: true })
            .add({
                targets: '.ml13 .letter',
                translateY: [20, 0],
                translateZ: 0,
                opacity: [0, 1],
                filter: ['blur(5px)', 'blur(0px)'],
                easing: "easeOutExpo",
                duration: 1200,
                delay: (el, i) => 300 + 20 * i,
            })
            .add({
                targets: '.ml13 .letter',
                translateY: [0, -20],
                opacity: [1, 0],
                filter: ['blur(0px)', 'blur(5px)'],
                easing: "easeInExpo",
                duration: 1000,
                delay: (el, i) => 15 * i,
                complete: function() {
                    hidePreloader();
                }
            }, '-=700');


        let themeStatus = JSON.parse(localStorage.getItem('REDEFINE-THEME-STATUS'))?.isDark;

        // If the theme status is not found in local storage, check the preferred color scheme
        if (themeStatus === undefined || themeStatus === null) {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                themeStatus = 'dark';
            } else {
                themeStatus = 'light';
            }
        }

        // Now you can use the themeStatus variable in your code
        if (themeStatus) {
            document.documentElement.style.setProperty('--preloader-background-color', '#202124');
            document.documentElement.style.setProperty('--preloader-text-color', '#fff');
        } else {
            document.documentElement.style.setProperty('--preloader-background-color', '#fff');
            document.documentElement.style.setProperty('--preloader-text-color', '#000');
        }

        window.addEventListener('load', function () {
            setTimeout(hidePreloader, 5000); // Call hidePreloader after 5000 milliseconds if not already called by animation
        });

        function hidePreloader() {
            var preloader = document.querySelector('.preloader');
            preloader.style.opacity = '0';
            setTimeout(function () {
                preloader.style.display = 'none';
            }, 200);
        }
    </script>
</div>

<main class="page-container" id="swup">

    

    <div class="main-content-container flex flex-col justify-between min-h-dvh">


        <div class="main-content-header">
            <header class="navbar-container px-6 md:px-12">
    <div class="navbar-content transition-navbar ">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                Paw5zx
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    首页
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/categories"
                                        >
                                    <i class="fa-regular fa-folder fa-fw"></i>
                                    分类
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="has-dropdown"
                                   href="#"
                                        onClick=&#34;return false;&#34;>
                                    <i class="fa-regular fa-link fa-fw"></i>
                                    链接
                                    <i class="fa-solid fa-chevron-down fa-fw"></i>
                                </a>

                                <!-- Submenu -->
                                
                                    <ul class="sub-menu">
                                        
                                            <li>
                                                <a target="_blank" rel="noopener" href="https://itanium-cxx-abi.github.io/cxx-abi/">
                                                    ITANIUM C++ ABI
                                                </a>
                                            </li>
                                        
                                            <li>
                                                <a target="_blank" rel="noopener" href="https://eel.is/c++draft/">
                                                    C++ STANDARD DRAFT
                                                </a>
                                            </li>
                                        
                                            <li>
                                                <a target="_blank" rel="noopener" href="https://gcc.godbolt.org/">
                                                    COMPILER EXPLORER
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/archives"
                                        >
                                    <i class="fa-regular fa-archive fa-fw"></i>
                                    归档
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i>
                    </div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-dvh w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                首页
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/categories"
                        >
                            <span>
                                分类
                            </span>
                            
                                <i class="fa-regular fa-folder fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item-sub text-base my-1.5 flex flex-col w-full">
                        
                        <div class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary cursor-pointer text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                             navbar-data-toggle="submenu-Links"
                        >
                            <span>
                                链接
                            </span>
                            
                                <i class="fa-solid fa-chevron-right fa-sm fa-fw transition-all"></i>
                            
                        </div>
                        

                        
                            <div class="flex-col items-start px-2 py-2 hidden" data-target="submenu-Links">
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           target="_blank" rel="noopener" href="https://itanium-cxx-abi.github.io/cxx-abi/">ITANIUM C++ ABI</a>
                                    </div>
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           target="_blank" rel="noopener" href="https://eel.is/c++draft/">C++ STANDARD DRAFT</a>
                                    </div>
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           target="_blank" rel="noopener" href="https://gcc.godbolt.org/">COMPILER EXPLORER</a>
                                    </div>
                                
                            </div>
                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/archives"
                        >
                            <span>
                                归档
                            </span>
                            
                                <i class="fa-regular fa-archive fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            

            
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">0</div>
        <div class="label text-third-text-color text-sm">标签</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">27</div>
        <div class="label text-third-text-color text-sm">分类</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">53</div>
        <div class="label text-third-text-color text-sm">文章</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="post-page-container flex relative justify-between box-border w-full h-full">
    <div class="article-content-container">

        <div class="article-title relative w-full">
            
                <div class="w-full flex items-center pt-6 justify-start">
                    <h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">SICK Ranger3源码分析——断线重连</h1>
                </div>
            
            </div>

        
            <div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
                <div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
                    <img src="/logos/O7_allmode.png">
                </div>
                <div class="info flex flex-col justify-between">
                    <div class="author flex items-center">
                        <span class="name text-default-text-color text-lg font-semibold">paw5zx</span>
                        
                            <span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">Lv4</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2025-03-09 00:19:32</span>
        <span class="mobile">2025-03-09 00:19:32</span>
        <span class="hover-info">创建</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2025-05-26 11:16:38</span>
            <span class="mobile">2025-05-26 11:16:38</span>
            <span class="hover-info">更新</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/%E5%B7%A5%E4%B8%9A%E7%9B%B8%E6%9C%BA/">工业相机</a>&nbsp;
                        </li>
                    
                    
                
                    
                        
                            <li>></li>
                        
                        <li>
                            <a href="/categories/%E5%B7%A5%E4%B8%9A%E7%9B%B8%E6%9C%BA/SICK/">SICK</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fa-regular fa-typewriter"></i>&nbsp;<span>6.7k 字</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fa-regular fa-clock"></i>&nbsp;<span>29 分钟</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        


        <div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>简单分析一下SICK Ranger3源码中断线重连的实现，这一块算是比较容易的，先择出来分析一下。</p>
<p>代码示例仅贴出关键部分以便分析</p>
<p>使用SDK版本为3.4.2.6</p>
<p>断线重连官方例程：Demo_R3_callback_with_heartbeat.cpp</p>
<h1 id="断线检测"><a href="#断线检测" class="headerlink" title="断线检测"></a>断线检测</h1><p>断线重连可以划分为两步，首先检测相机断线并通知，然后用户在收到通知后进行重连操作。我们先看SICK如何实现断线检测。</p>
<p>断线检测机制内置于SICK SDK中，由SICK SDK管理：</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: Ranger.cpp</span></span><br><span class="line"><span class="function">EXPORT_TO_DLL CAM_STATUS</span></span><br><span class="line"><span class="function"><span class="title">Ranger3::connectCamera</span><span class="params">(CallbackEvent_HeartBeats pCallback, <span class="type">const</span> <span class="type">uint32_t</span>&amp; microSecond, <span class="type">void</span> * any)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">		<span class="keyword">auto</span> e = <span class="built_in">connectCamera</span>();</span><br><span class="line">		<span class="keyword">if</span>(e == CAM_STATUS::All_OK)</span><br><span class="line">		&#123;</span><br><span class="line">            m_heartbeat_is_on = <span class="number">1</span>;</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">// 开启心跳检测线程</span></span><br><span class="line">			<span class="keyword">auto</span> _thread = std::<span class="built_in">make_shared</span>&lt;std::thread&gt;(&amp;Ranger3::_check_HeartBeats_run, <span class="keyword">this</span>);</span><br><span class="line">			_thread-&gt;<span class="built_in">detach</span>();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> e;</span><br><span class="line">	&#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line">Ranger3::_check_HeartBeats_run()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span> (m_heartbeat_is_on==<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        __sleep1MS(m_heartbeat_interval);</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="function">Str <span class="title">value</span><span class="params">(<span class="string">&quot;&quot;</span>)</span></span>;</span><br><span class="line">            <span class="comment">// 设备在线，不抛异常，反之，抛出异常</span></span><br><span class="line">            m_Param.<span class="built_in">getParameter</span>(m_deviceNodeMap, <span class="string">&quot;DeviceTemperature&quot;</span>, value);</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">catch</span> (...) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>可以看出，断线检测机制很简单，就是分离一个线程，循环访问相机寄存器（SICK的实现是通过定时获取设备温度访问相机寄存器），若访问不到（失败），就意味着相机已离线。</p>

  <div class="note-large purple">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>Paw5zx注：</p>

    </div>
    <div class="notel-content">
      
    </div>
  </div>


<h1 id="断线通知"><a href="#断线通知" class="headerlink" title="断线通知"></a>断线通知</h1><p>断线通知机制同样内置于SICK SDK中：在检测到设备离线后，调用注册好的回调函数（注册过程将在下文介绍）</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: Ranger.cpp</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line">Ranger3::_check_HeartBeats_run()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span> (m_heartbeat_is_on==<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        __sleep1MS(m_heartbeat_interval);</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="function">Str <span class="title">value</span><span class="params">(<span class="string">&quot;&quot;</span>)</span></span>;</span><br><span class="line">            <span class="comment">// 设备在线，不抛异常，反之，抛出异常</span></span><br><span class="line">            m_Param.<span class="built_in">getParameter</span>(m_deviceNodeMap, <span class="string">&quot;DeviceTemperature&quot;</span>, value);</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">catch</span> (...) &#123;</span><br><span class="line">            <span class="comment">// 一些资源释放操作</span></span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">// m_on_lost_function为注册好的回调函数对象</span></span><br><span class="line">            <span class="comment">// 设备离线，访问寄存器失败，捕获异常，调用m_on_lost_function</span></span><br><span class="line">            <span class="keyword">auto</span> _thread = std::<span class="built_in">make_shared</span>&lt;std::thread&gt;(m_on_lost_function, &amp;m_DeviceName, &amp;m_DeviceIP, &amp;m_on_lost_mac, &amp;msg, m_on_lost_inputs);</span><br><span class="line">			_thread-&gt;<span class="built_in">join</span>();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>


<h1 id="重连实现"><a href="#重连实现" class="headerlink" title="重连实现"></a>重连实现</h1><p>重连机制的具体实现由用户进行。在例程<code>Demo_R3_callback_with_heartbeat.cpp</code>中，由用户自定义一个回调函数（在相机离线时会被调用），回调内循环对相机进行重连操作。用户在连接相机时注册这个回调</p>
<p>用户层代码：</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: Demo_R3_callback_with_heartbeat.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 用户定义的回调函数，在相机断开连接时被调用</span></span><br><span class="line"><span class="function"><span class="type">void</span> SICK_CALLBACK</span></span><br><span class="line"><span class="function"><span class="title">on_lost_device_Demo_R3_callback_with_heartbeat</span><span class="params">(std::string* name, std::string* ip, std::string* mac, std::string* msg, <span class="type">void</span> * pR3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> pCam = (SickCam::Ranger3*)pR3;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 根据相机对象存储的设备信息对物理相机进行重连操作，不展开说明了</span></span><br><span class="line">        <span class="keyword">auto</span> ec = pCam-&gt;<span class="built_in">reconnectCamera</span>();</span><br><span class="line">        ...</span><br><span class="line">        __sleep1MS(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 连接相机时注册回调</span></span><br><span class="line"><span class="keyword">auto</span> err = pCam1-&gt;<span class="built_in">connectCamera</span>(on_lost_device_Demo_R3_callback_with_heartbeat, <span class="number">1000</span>, pCam<span class="number">1.</span><span class="built_in">get</span>());</span><br></pre></td></tr></table></figure></div>

<p>在SICK SDK中，注册过程会：</p>
<ul>
<li>将用户注册的<code>on_lost_device_Demo_R3_callback_with_heartbeat</code>赋值给<code>m_on_lost_function</code></li>
<li>将用户传递上下文信息<code>any</code>赋值给<code>m_on_lost_inputs</code></li>
</ul>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: Ranger3.h</span></span><br><span class="line"><span class="keyword">typedef</span> std::function&lt;<span class="type">void</span>(std::string* name, std::string* ip, std::string* mac, std::string* msg, <span class="type">void</span>* any)&gt;  CallbackEvent_HeartBeats;</span><br><span class="line"></span><br><span class="line"><span class="comment">// file: Ranger.cpp</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">[in] – pCallback 当失去心跳时，将调用由用户定义的回调函数。相应的处理可以在此函数中执行。</span></span><br><span class="line"><span class="comment">[in] – microSecond 读取心跳的时间间隔，单位毫秒，推荐值为 10 000;</span></span><br><span class="line"><span class="comment">[in] – any 在失去心跳的响应函数（CallbackEvent_HeartBeats）中，该指针将作为输入参数，由用户定义。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">EXPORT_TO_DLL CAM_STATUS</span></span><br><span class="line"><span class="function"><span class="title">Ranger3::connectCamera</span><span class="params">(CallbackEvent_HeartBeats pCallback, <span class="type">const</span> <span class="type">uint32_t</span>&amp; microSecond, <span class="type">void</span> * any)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">		<span class="keyword">auto</span> e = <span class="built_in">connectCamera</span>();</span><br><span class="line">		<span class="keyword">if</span>(e == CAM_STATUS::All_OK)</span><br><span class="line">		&#123;</span><br><span class="line">			...</span><br><span class="line">            m_on_lost_function = pCallback;</span><br><span class="line">			m_on_lost_inputs = any;</span><br><span class="line">			<span class="keyword">auto</span> _thread = std::<span class="built_in">make_shared</span>&lt;std::thread&gt;(&amp;Ranger3::_check_HeartBeats_run, <span class="keyword">this</span>);</span><br><span class="line">			_thread-&gt;<span class="built_in">detach</span>();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> e;</span><br><span class="line">	&#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>注册完毕后，当相机出现离线情况，就如<a href="./#%E6%96%AD%E7%BA%BF%E9%80%9A%E7%9F%A5">上文所述</a>，SDK会调用注册的回调函数进行重连。</p>
<h1 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h1><p>在此仅记录一下我自己使用时发现的小问题。套个盾，我使用的SDK版本到目前为止肯定不是最新版本，以下提到的问题很有可能已在新版本被修复。</p>
<h2 id="重连时失败"><a href="#重连时失败" class="headerlink" title="重连时失败"></a>重连时失败</h2><p>此问题由多个因素综合导致，先汇总现象，后逐个分析</p>
<ul>
<li>①设备掉线后进程崩溃。<a href="#%E8%AE%BE%E5%A4%87%E6%8E%89%E7%BA%BF%E5%90%8E%E8%BF%9B%E7%A8%8B%E5%B4%A9%E6%BA%83">点此快速跳转</a></li>
<li>②修复①后，在设备断线后重连时无法正常连接，且有报错<code>GenTL call failed: -1006, Message: Requested handle not found in the pool</code>。<a href="#%E6%96%AD%E7%BA%BF%E5%90%8E%E6%97%A0%E6%B3%95%E6%AD%A3%E5%B8%B8%E9%87%8D%E8%BF%9E">点此快速跳转</a></li>
</ul>
<p>在逐步分析之前，我们先总结一下相关的成员变量与函数。</p>
<h3 id="成员变量"><a href="#成员变量" class="headerlink" title="成员变量"></a>成员变量</h3><h4 id="m-connectedDevices"><a href="#m-connectedDevices" class="headerlink" title="m_connectedDevices"></a>m_connectedDevices</h4><h5 id="声明及初始化"><a href="#声明及初始化" class="headerlink" title="声明及初始化"></a>声明及初始化</h5><div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> std::map&lt;Str, SPtr&lt;DeviceConnection&gt;&gt; deviceList;</span><br><span class="line"><span class="type">static</span> deviceList	m_connectedDevices;</span><br><span class="line">deviceList			CameraShared::m_connectedDevices= <span class="built_in">deviceList</span>();</span><br></pre></td></tr></table></figure></div>

<h5 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h5><p>已连接设备表，用于管理设备名称和设备连接对象的映射关系。表中管理所有连接至主机的GenICam设备（包含SICK设备和非SICK设备）</p>
<h5 id="元素增加"><a href="#元素增加" class="headerlink" title="元素增加"></a>元素增加</h5><p>在<code>_add_device()</code>中</p>
<ul>
<li>对于非SICK的GenICam设备，如果没有在<code>m_connectedDevices</code>中被管理，则将其加入；</li>
<li>对于SICK的GenICam设备，如果其已经被管理，则什么都不做；如果没有在<code>m_connectedDevices</code>中被管理，则将其加入。</li>
</ul>
<details class="blue" data-header-exclude><summary><i class="fa-solid fa-chevron-right"></i>代码折叠，点击展开 </summary>
              <div class='content'>
              <div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">CameraShared::_add_device(	cStr&amp;               interfaceName,</span><br><span class="line">							GenTL::IF_HANDLE	interfaceHandle,</span><br><span class="line">							<span class="type">const</span> SiDeviceList&amp;	devices,</span><br><span class="line">							<span class="type">const</span> <span class="type">int64_t</span>&amp;		id,</span><br><span class="line">							<span class="type">int</span> &amp; nDevices)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 非SICK设备</span></span><br><span class="line">	<span class="keyword">if</span> (device_name == <span class="string">&quot;&quot;</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(m_connectedDevices.<span class="built_in">count</span>(it-&gt;first) == <span class="number">0</span>)</span><br><span class="line">			m_connectedDevices.<span class="built_in">insert</span>(&#123; it-&gt;first, std::<span class="built_in">make_shared</span>&lt;DeviceConnection&gt;(it-&gt;first)&#125;);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 已管理的SICK设备</span></span><br><span class="line">    <span class="keyword">if</span> (m_connectedDevices.<span class="built_in">count</span>(device_name) == <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		...</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 未管理的SICK设备</span></span><br><span class="line">	<span class="keyword">auto</span> pDev = std::<span class="built_in">make_shared</span>&lt;DeviceConnection&gt;(	m_pconsumer,</span><br><span class="line">													interfaceHandle,</span><br><span class="line">													devices,</span><br><span class="line">													id,</span><br><span class="line">													interfaceName);</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">    </span><br><span class="line">    m_connectedDevices.<span class="built_in">insert</span>(&#123;pDev-&gt;mDeviceName, pDev&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
              </div>
            </details>

<h5 id="元素减少"><a href="#元素减少" class="headerlink" title="元素减少"></a>元素减少</h5><p>在这里我们仅总结与断线重连问题相关的地方。</p>
<p>在<code>_clear_invalid_device()</code>中，直接删除名称为函数参数<code>name</code>的条目</p>
<details class="blue" data-header-exclude><summary><i class="fa-solid fa-chevron-right"></i>代码折叠，点击展开 </summary>
              <div class='content'>
              <div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">CameraShared::_clear_invalid_device(cStr&amp; name)</span><br><span class="line">&#123;</span><br><span class="line">    m_connectedDevices.<span class="built_in">erase</span>(name);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
              </div>
            </details>

<h4 id="m-Interfaces-Map"><a href="#m-Interfaces-Map" class="headerlink" title="m_Interfaces_Map"></a>m_Interfaces_Map</h4><h5 id="声明及初始化-1"><a href="#声明及初始化-1" class="headerlink" title="声明及初始化"></a>声明及初始化</h5><div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 类型我自己更改了一下</span></span><br><span class="line"><span class="type">static</span> std::map&lt;std::string, GenTL::IF_HANDLE&gt;  m_Interfaces_Map;</span><br><span class="line">std::map&lt;std::string, GenTL::IF_HANDLE&gt;         CameraShared::m_Interfaces_Map;</span><br></pre></td></tr></table></figure></div>

<h5 id="描述-1"><a href="#描述-1" class="headerlink" title="描述"></a>描述</h5><p>可用接口表，用于管理接口名称与接口句柄的映射关系，例如对于以太网口，名称可能是<code>enp3s0</code>。表中管理所有挂载了GenICam设备（包含SICK设备和非SICK设备）的接口</p>
<h5 id="元素增加-1"><a href="#元素增加-1" class="headerlink" title="元素增加"></a>元素增加</h5><p>只有一处涉及到其元素的增加，即在<code>_scan_interface()</code>中，当检测到当前物理接口下挂载了GenICam设备（包含SICK设备和非SICK设备）且当前物理接口还没有在此表中管理，则向此表中插入一条<code>&#123;&lt;接口名称&gt;, &lt;接口句柄&gt;&#125;</code></p>
<details class="blue" data-header-exclude><summary><i class="fa-solid fa-chevron-right"></i>代码折叠，点击展开 </summary>
              <div class='content'>
              <div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">CameraShared::_scan_interface(cStr&amp;               interfaceName,</span><br><span class="line">                              GenTL::IF_HANDLE	  interfaceHandle,</span><br><span class="line">                              <span class="type">int</span> &amp;               nDevices)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">auto</span> devices = m_pconsumer-&gt;<span class="built_in">getDevices_is_changed</span>(interfaceHandle);</span><br><span class="line">    <span class="keyword">if</span> (!devices.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(m_Interfaces_Map.<span class="built_in">count</span>(interfaceName) == <span class="number">0</span>)</span><br><span class="line">            m_Interfaces_Map.<span class="built_in">insert</span>(&#123;interfaceName, interfaceHandle&#125;);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
              </div>
            </details>

<h5 id="元素减少-1"><a href="#元素减少-1" class="headerlink" title="元素减少"></a>元素减少</h5><p>在这里我们仅总结与断线重连问题相关的地方。</p>
<p>在<code>_clear_invalid_device()</code>中，遍历<a href="#m-Device-inInterface-Map">接口-设备表</a>中的每个元素：</p>
<ul>
<li>若接口下的设备名称集合为空（这里先不讨论什么情况下会为空），则说明接口不需要了，先通过<code>IFClose</code>关闭接口句柄（SDK源码中并没有这一步），然后移除此映射表中与当前接口对应的条目</li>
<li>若接口下的设备名称集合不为空，且存在着要删除的SICK设备（其名称通过<code>_clear_invalid_device()</code>的参数<code>name</code>传入），则将其名称移出设备名称集合，并再次检查当前接口下的设备名称集合是否为空，若此时为空，则移除此映射表中与当前接口对应的条目</li>
</ul>

  <div class="note-large purple">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>Paw5zx注：</p>

    </div>
    <div class="notel-content">
      <p>我认为<code>_clear_invalid_device</code>中的代码逻辑和实现是有问题的，这里先展示SDK提供的源码，在<a href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90">《问题分析》</a>中会继续分析</p>

    </div>
  </div>

<details class="blue" data-header-exclude><summary><i class="fa-solid fa-chevron-right"></i>代码折叠，点击展开 </summary>
              <div class='content'>
              <div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">CameraShared::_clear_invalid_device(cStr&amp; name)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> devs = m_Device_inInterface_Map.<span class="built_in">begin</span>(); devs!= m_Device_inInterface_Map.<span class="built_in">end</span>();)</span><br><span class="line">    &#123;</span><br><span class="line">		<span class="keyword">if</span> (devs-&gt;second.<span class="built_in">empty</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			</span><br><span class="line">			m_Interfaces_Map.<span class="built_in">erase</span>(devs-&gt;first);</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (devs-&gt;second.<span class="built_in">count</span>(name) == <span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			devs-&gt;second.<span class="built_in">erase</span>(name);</span><br><span class="line">            ...</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(devs-&gt;second.<span class="built_in">empty</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            ...</span><br><span class="line">            m_pconsumer-&gt;<span class="built_in">closeInterface</span>(m_Interfaces_Map[devs-&gt;first]);</span><br><span class="line"></span><br><span class="line">            m_Interfaces_Map.<span class="built_in">erase</span>(devs-&gt;first);</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			++devs;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
              </div>
            </details>

<h4 id="m-Device-inInterface-Map"><a href="#m-Device-inInterface-Map" class="headerlink" title="m_Device_inInterface_Map"></a>m_Device_inInterface_Map</h4><h5 id="声明及初始化-2"><a href="#声明及初始化-2" class="headerlink" title="声明及初始化"></a>声明及初始化</h5><div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> std::map&lt;std::string, std::set&lt;std::string&gt;&gt;     m_Device_inInterface_Map;</span><br><span class="line">std::map&lt;std::string, std::set&lt;std::string&gt;&gt;            CameraShared::m_Device_inInterface_Map;</span><br></pre></td></tr></table></figure></div>

<h5 id="描述-2"><a href="#描述-2" class="headerlink" title="描述"></a>描述</h5><p>接口-设备表，用于管理接口名称与其下挂载的GenICam设备（仅SICK设备）集合的映射关系。表中管理所有挂载了GenICam设备（包含SICK设备和非SICK设备）的接口，但是其对应的设备名称集合下，仅记录SICK设备。</p>
<h5 id="元素增加-2"><a href="#元素增加-2" class="headerlink" title="元素增加"></a>元素增加</h5><p>映射表元素的增加是在<code>_scan_interface()</code>中，当检测到当前物理接口下挂载了GenICam设备（包含SICK设备和非SICK设备），且当前物理接口还没有在此表中管理，则向表中插入一条<code>&#123;&lt;接口名称&gt;, &#123;&#125;&#125;</code>，其中<code>&#123;&#125;</code>代表空设备集</p>
<details class="blue" data-header-exclude><summary><i class="fa-solid fa-chevron-right"></i>代码折叠，点击展开 </summary>
              <div class='content'>
              <div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">CameraShared::_scan_interface(cStr&amp;               interfaceName,</span><br><span class="line">                              GenTL::IF_HANDLE	  interfaceHandle,</span><br><span class="line">                              <span class="type">int</span> &amp;               nDevices)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">auto</span> devices = m_pconsumer-&gt;<span class="built_in">getDevices_is_changed</span>(interfaceHandle);</span><br><span class="line">    <span class="keyword">if</span> (!devices.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span>(m_Device_inInterface_Map.<span class="built_in">count</span>(interfaceName) == <span class="number">0</span>)</span><br><span class="line">            m_Device_inInterface_Map.<span class="built_in">insert</span>(&#123;interfaceName, std::<span class="built_in">set</span>&lt;std::string&gt;()&#125;);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
              </div>
            </details>

<p>而设备集内元素的增加则是在<code>_add_device()</code>中，当成功创建了SICK设备的连接后，会将此SICK设备的名称加入到映射表中对应物理接口条目下的设备名称集合中。</p>
<details class="blue" data-header-exclude><summary><i class="fa-solid fa-chevron-right"></i>代码折叠，点击展开 </summary>
              <div class='content'>
              <div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">CameraShared::_add_device(	cStr&amp;               interfaceName,</span><br><span class="line">							GenTL::IF_HANDLE	interfaceHandle,</span><br><span class="line">							<span class="type">const</span> SiDeviceList&amp;	devices,</span><br><span class="line">							<span class="type">const</span> <span class="type">int64_t</span>&amp;		id,</span><br><span class="line">							<span class="type">int</span> &amp; nDevices)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 成功创建了新SICK设备的连接后</span></span><br><span class="line">	<span class="keyword">auto</span> pDev = std::<span class="built_in">make_shared</span>&lt;DeviceConnection&gt;(	m_pconsumer,</span><br><span class="line">													interfaceHandle,</span><br><span class="line">													devices,</span><br><span class="line">													id,</span><br><span class="line">													interfaceName);</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">    m_Device_inInterface_Map[interfaceName].<span class="built_in">insert</span>(pDev-&gt;mDeviceName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
              </div>
            </details>

<h5 id="元素减少-2"><a href="#元素减少-2" class="headerlink" title="元素减少"></a>元素减少</h5><p>在<code>_clear_invalid_device()</code>中，遍历此映射表中的每个元素：</p>
<ul>
<li>若接口下的设备名称集合为空（这里先不讨论什么情况下会为空），则说明接口不需要了，移除此映射表中与当前接口对应的条目</li>
<li>若接口下的设备名称集合不为空，且存在着要删除的SICK设备（其名称通过<code>_clear_invalid_device()</code>的参数<code>name</code>传入），则将其名称移出接口对应的设备名称集合，并再次检查当前接口下的设备名称集合是否为空，若此时为空，则移除此映射表中与当前接口对应的条目</li>
</ul>
<details class="blue" data-header-exclude><summary><i class="fa-solid fa-chevron-right"></i>代码折叠，点击展开 </summary>
              <div class='content'>
              <div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">CameraShared::_clear_invalid_device(cStr&amp; name)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> devs = m_Device_inInterface_Map.<span class="built_in">begin</span>(); devs!= m_Device_inInterface_Map.<span class="built_in">end</span>();)</span><br><span class="line">    &#123;</span><br><span class="line">		<span class="keyword">if</span> (devs-&gt;second.<span class="built_in">empty</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			</span><br><span class="line">			m_Device_inInterface_Map.<span class="built_in">erase</span>(devs++);</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (devs-&gt;second.<span class="built_in">count</span>(name) == <span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			devs-&gt;second.<span class="built_in">erase</span>(name);</span><br><span class="line">            ...</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(devs-&gt;second.<span class="built_in">empty</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            ...</span><br><span class="line">            m_pconsumer-&gt;<span class="built_in">closeInterface</span>(m_Interfaces_Map[devs-&gt;first]);</span><br><span class="line"></span><br><span class="line">            m_Device_inInterface_Map.<span class="built_in">erase</span>(devs++);</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			++devs;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
              </div>
            </details>

<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><p>主要的函数都位于<code>CameraShared</code>这个类中，这个类感觉可以理解为一个SDK中的最顶层的管理类，管理了要使用的接口和设备等</p>
<h4 id="scan-Device"><a href="#scan-Device" class="headerlink" title="_scan_Device"></a>_scan_Device</h4><h5 id="声明"><a href="#声明" class="headerlink" title="声明"></a>声明</h5><div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CAM_STATUS			_scan_Device(<span class="type">int</span>&amp; numberDeviceNewFound);</span><br></pre></td></tr></table></figure></div>
<h5 id="描述-3"><a href="#描述-3" class="headerlink" title="描述"></a>描述</h5><p>扫描当前系统中所有可用接口下的设备，并更新<code>m_Device_inInterface_Map</code>，<code>m_Interfaces_Map</code>和<code>m_connectedDevices</code></p>
<h5 id="内部逻辑"><a href="#内部逻辑" class="headerlink" title="内部逻辑"></a>内部逻辑</h5><ul>
<li>调用<code>TLUpdateInterfaceList()</code>更新Producer内部管理的可用接口列表，并在当前函数中记录一个临时的可用接口列表<code>interfaces</code>，列表内各元素为<code>&#123;&lt;接口模块ID&gt;, &lt;接口的用户可读名称&gt;&#125;</code></li>
<li>为<code>interfaces</code>中的每个可用接口创建类型为<code>GenTL::IF_HANDLE</code>的接口句柄<code>interfaceHandle</code>：<ul>
<li>如果接口已经在<code>m_Interfaces_Map</code>中被管理，意味着其对应的接口句柄还存在，所以直接令<code>interfaceHandle</code>等于<code>m_Interfaces_Map</code>中管理的句柄即可</li>
<li>若接口不在<code>m_Interfaces_Map</code>中，意味着这可能是一个新的可用接口，会调用<code>TLOpenInterface()</code>打开接口，然后将句柄赋值给<code>interfaceHandle</code></li>
</ul>
</li>
<li>对<code>interfaces</code>中的每个成功打开的可用接口调用<a href="#scan-interface">_scan_interface()</a></li>
</ul>
<h5 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h5><details class="blue" data-header-exclude><summary><i class="fa-solid fa-chevron-right"></i>代码折叠，点击展开 </summary>
              <div class='content'>
              <div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">CAM_STATUS</span><br><span class="line">CameraShared::_scan_Device(<span class="type">int</span>&amp; numberDeviceNewFound)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CALLBACK_NEW</span></span><br><span class="line">	<span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(m_mutex_scan)</span></span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	*m_log &lt;&lt; CustomerLog::<span class="built_in">time</span>() &lt;&lt; <span class="string">&quot;[CameraShared::scan_Device]: scan_Device() start \n&quot;</span>;</span><br><span class="line">	<span class="keyword">if</span> (m_tlHandle == GENTL_INVALID_HANDLE)	<span class="keyword">return</span>	CAM_STATUS::ERROR_OPEN_TL_HANDLE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// new found interface</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __linux__</span></span><br><span class="line">	<span class="keyword">auto</span> interfaces = m_pconsumer-&gt;<span class="built_in">getInterfaces</span>(m_tlHandle);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _WIN32</span></span><br><span class="line">	<span class="keyword">auto</span> interfaces = _getInterfaces(m_tlHandle, m_sTl);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	*m_log &lt;&lt; CustomerLog::<span class="built_in">time</span>() &lt;&lt; <span class="string">&quot;[CameraShared::scan_Device]: interfaces.size() = &quot;</span> &lt;&lt; interfaces.<span class="built_in">size</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; interfaces.<span class="built_in">size</span>(); ++i)</span><br><span class="line">	&#123;	</span><br><span class="line">		<span class="keyword">auto</span> interfaceName = interfaces[i].second;</span><br><span class="line">		GenTL::TL_HANDLE interfaceHandle = GENTL_INVALID_HANDLE;</span><br><span class="line">		<span class="keyword">if</span> (m_Interfaces_Map.<span class="built_in">count</span>(interfaceName) == <span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			interfaceHandle = m_Interfaces_Map[interfaceName]; <span class="comment">// has been saved in pervious scan</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __linux__</span></span><br><span class="line">			interfaceHandle = m_pconsumer-&gt;<span class="built_in">openInterfaceById</span>(_findInterfaceByIndex(interfaces, i));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _WIN32</span></span><br><span class="line">			interfaceHandle = _openInterfaceById(_findInterfaceByIndex(interfaces, i), m_tlHandle, m_sTl); <span class="comment">// interface new found</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (interfaceHandle == GENTL_INVALID_HANDLE)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">		*m_log &lt;&lt; CustomerLog::<span class="built_in">time</span>() &lt;&lt; <span class="string">&quot;[CameraShared::scan_Device]: Open Interface : &quot;</span> &lt;&lt; interfaceName &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">		_scan_interface(interfaceName, interfaceHandle, numberDeviceNewFound);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	*m_log &lt;&lt; CustomerLog::<span class="built_in">time</span>() &lt;&lt; <span class="string">&quot;[CameraShared::scan_Device]: The number of available interfaces: &quot;</span> &lt;&lt; m_Device_inInterface_Map.<span class="built_in">size</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">auto</span> sub : m_Device_inInterface_Map)</span><br><span class="line">	&#123;</span><br><span class="line">		*m_log &lt;&lt; CustomerLog::<span class="built_in">time</span>() &lt;&lt; <span class="string">&quot;[CameraShared::scan_Device]:      Interface: &quot;</span> &lt;&lt; sub.first &lt;&lt; <span class="string">&quot;: \n&quot;</span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">auto</span> sub_second : sub.second)</span><br><span class="line">		&#123;</span><br><span class="line">			*m_log &lt;&lt; CustomerLog::<span class="built_in">time</span>() &lt;&lt; <span class="string">&quot;[CameraShared::scan_Device]:             Dev - &quot;</span> &lt;&lt; sub_second &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    m_isDevFound = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">auto</span> sub:m_connectedDevices)</span><br><span class="line">    &#123;</span><br><span class="line">	    <span class="keyword">if</span>(sub.second-&gt;mDeviceName != <span class="string">&quot;&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            m_isDevFound = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//m_isDevFound = !m_connectedDevices.empty();</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// final check</span></span><br><span class="line">	<span class="keyword">if</span> (numberDeviceNewFound &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		*m_log &lt;&lt; CustomerLog::<span class="built_in">time</span>() &lt;&lt; <span class="string">&quot;[CameraShared::scan_Device]: After scanning all interfaces, &quot;</span> &lt;&lt; numberDeviceNewFound &lt;&lt; <span class="string">&quot; new device(s) found!\n\n\n&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span> CAM_STATUS::All_OK;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	*m_log &lt;&lt; CustomerLog::<span class="built_in">time</span>() &lt;&lt; <span class="string">&quot;[CameraShared::scan_Device]: After scanning all interfaces, no new device found!\n\n\n&quot;</span>;</span><br><span class="line">	<span class="keyword">return</span> CAM_STATUS::All_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
              </div>
            </details>


<h4 id="scan-interface"><a href="#scan-interface" class="headerlink" title="_scan_interface"></a>_scan_interface</h4><h5 id="声明-1"><a href="#声明-1" class="headerlink" title="声明"></a>声明</h5><div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">[in]interfaceName: 接口名称</span></span><br><span class="line"><span class="comment">[in]interfaceHandle: 接口句柄</span></span><br><span class="line"><span class="comment">[out]nDevices: 设备数量</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span>        _scan_interface(cStr&amp;               interfaceName,</span><br><span class="line">                            GenTL::IF_HANDLE	interfaceHandle,</span><br><span class="line">                            <span class="type">int</span> &amp;               nDevices);</span><br></pre></td></tr></table></figure></div>
<h5 id="描述-4"><a href="#描述-4" class="headerlink" title="描述"></a>描述</h5><p>此函数对单个接口调用，用于扫描指定接口下的设备，并更新<code>m_Device_inInterface_Map</code>，<code>m_Interfaces_Map</code>和<code>m_connectedDevices</code></p>
<h5 id="内部逻辑-1"><a href="#内部逻辑-1" class="headerlink" title="内部逻辑"></a>内部逻辑</h5><ul>
<li>调用<code>IFUpdateDeviceList()</code>更新Producer内部管理的可用设备列表，并在当前函数中记录一个临时的可用设备列表<code>devices</code>，列表中管理这当前接口下挂载的所有GenICam设备（包含SICK设备和非SICK设备）。<ul>
<li>对于非SICK设备，其在<code>devices</code>中对应的元素格式为<code>&#123;&lt;modelName&gt;(&lt;sn&gt;), &quot;&quot;&#125;</code></li>
<li>对于SICK设备，其在<code>devices</code>中对应的元素格式为<code>&#123;&lt;deviceId&gt;, &lt;deviceId&gt;_&lt;deviceUserId&gt;&#125;</code></li>
</ul>
</li>
<li>如果<code>devices</code>非空（即当前接口下挂载了GenICam设备），则<ul>
<li>若<code>m_Interfaces_Map</code>中没有管理当前接口，则将接口加入</li>
<li>若<code>m_Device_inInterface_Map</code>中没有管理当前接口，则将接口加入，并且设置接口下设备名称集合为空</li>
<li>对于<code>devices</code>中的每个设备调用<a href="#add-device">_add_device()</a></li>
</ul>
</li>
<li>如果<code>devices</code>为空（即当前接口下未挂载任何GenICam设备），则<ul>
<li>若<code>m_Interfaces_Map</code>中没有管理当前接口，则调用<code>IFClose()</code>关闭当前接口句柄</li>
</ul>
</li>
</ul>
<h5 id="代码-1"><a href="#代码-1" class="headerlink" title="代码"></a>代码</h5><details class="blue" data-header-exclude><summary><i class="fa-solid fa-chevron-right"></i>代码折叠，点击展开 </summary>
              <div class='content'>
              <div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">CameraShared::_scan_interface(cStr&amp;               interfaceName,</span><br><span class="line">                              GenTL::IF_HANDLE	  interfaceHandle,</span><br><span class="line">                              <span class="type">int</span> &amp;               nDevices)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __linux__</span></span><br><span class="line">    <span class="keyword">auto</span> devices = m_pconsumer-&gt;<span class="built_in">getDevices_is_changed</span>(interfaceHandle);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="keyword">auto</span> devices = _getDevices_is_changed(interfaceHandle, m_sTl);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">if</span> (!devices.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(m_Interfaces_Map.<span class="built_in">count</span>(interfaceName) == <span class="number">0</span>)</span><br><span class="line">            m_Interfaces_Map.<span class="built_in">insert</span>(&#123;interfaceName, interfaceHandle&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(m_Device_inInterface_Map.<span class="built_in">count</span>(interfaceName) == <span class="number">0</span>)</span><br><span class="line">            m_Device_inInterface_Map.<span class="built_in">insert</span>(&#123;interfaceName, std::<span class="built_in">set</span>&lt;std::string&gt;()&#125;);</span><br><span class="line"></span><br><span class="line">		*m_log &lt;&lt; CustomerLog::<span class="built_in">time</span>() &lt;&lt; <span class="string">&quot;    [CameraShared::_scan_interface]: # Interface: &quot;</span> &lt;&lt; interfaceName &lt;&lt; <span class="string">&quot; has GenICam device(s)! \n&quot;</span>;</span><br><span class="line">		*m_log &lt;&lt; CustomerLog::<span class="built_in">time</span>() &lt;&lt; <span class="string">&quot;    [CameraShared::_scan_interface]: # Find total &quot;</span> &lt;&lt; devices.<span class="built_in">size</span>() &lt;&lt; <span class="string">&quot; GenICam device(s) in Interface. \n&quot;</span>;</span><br><span class="line">		</span><br><span class="line">		nDevices = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> j = <span class="number">0</span>; j &lt; devices.<span class="built_in">size</span>(); ++j)</span><br><span class="line">            _add_device(interfaceName, interfaceHandle, devices, j, nDevices);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">        <span class="keyword">if</span> (m_Interfaces_Map.<span class="built_in">count</span>(interfaceName) == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __linux__</span></span><br><span class="line">            m_pconsumer-&gt;<span class="built_in">closeInterface</span>(interfaceHandle);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">            _closeInterface(interfaceHandle, m_sTl);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            *m_log &lt;&lt; CustomerLog::<span class="built_in">time</span>() &lt;&lt; <span class="string">&quot;[CameraShared::_scan_interface]:         Warning: No device in Interface: &quot;</span> &lt;&lt; interfaceName &lt;&lt; <span class="string">&quot;).\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
              </div>
            </details>



<h4 id="add-device"><a href="#add-device" class="headerlink" title="_add_device"></a>_add_device</h4><h5 id="声明-2"><a href="#声明-2" class="headerlink" title="声明"></a>声明</h5><div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// [in]interfaceName: 接口名称</span></span><br><span class="line"><span class="comment">// [in]interfaceHandle: 接口句柄</span></span><br><span class="line"><span class="comment">// [in]devices: 设备列表</span></span><br><span class="line"><span class="comment">// [in]id: 设备索引</span></span><br><span class="line"><span class="comment">// [out]nDevices: 设备数量</span></span><br><span class="line"><span class="type">void</span>        _add_device		(   cStr&amp;               interfaceName,</span><br><span class="line">							    GenTL::IF_HANDLE	interfaceHandle,</span><br><span class="line">								<span class="type">const</span> SiDeviceList&amp;	devices,</span><br><span class="line">								<span class="type">const</span> <span class="type">int64_t</span>&amp;		id,</span><br><span class="line">								<span class="type">int</span> &amp;               nDevices);</span><br></pre></td></tr></table></figure></div>
<h5 id="描述-5"><a href="#描述-5" class="headerlink" title="描述"></a>描述</h5><p>此函数在单个接口下对单个设备调用，用于为新GenICam设备创建设备对象（封装了设备句柄的<code>DeviceConnection</code>）。注意：</p>
<ul>
<li>对于SICK和非SICK设备，创建设备对象的逻辑是不同的，但二者都会被加入<code>m_connectedDevices</code>（若之前没加入）。</li>
<li>SICK设备会被加入到<code>m_Device_inInterface_Map</code>中当前接口下的设备名称集合，而非SICK设备则不会</li>
</ul>
<h5 id="内部逻辑-2"><a href="#内部逻辑-2" class="headerlink" title="内部逻辑"></a>内部逻辑</h5><ul>
<li>接口有效性检查，检查当前接口是否在<code>m_Device_inInterface_Map</code>中被管理</li>
<li>在GenIcam设备列表中寻找第<code>id</code>个设备<ul>
<li>若此设备为非SICK设备且在<code>m_connectedDevices</code>中未被管理，则将其加入管理，然后返回。注意此设备对应的<code>DeviceConnection</code>为为非SICK设备准备的空构造</li>
<li>若此设备为SICK设备且已在<code>m_connectedDevices</code>中被管理，直接返回。</li>
<li>若此设备为SICK设备且在<code>m_connectedDevices</code>中未被管理（意味着是新发现的SICK设备），则为其创建<code>DeviceConnection</code>。若成功创建，则更新<code>m_connectedDevices</code>，并更新<code>m_Device_inInterface_Map</code>中当前接口下的设备名称集合</li>
</ul>
</li>
</ul>
<h5 id="代码-2"><a href="#代码-2" class="headerlink" title="代码"></a>代码</h5><details class="blue" data-header-exclude><summary><i class="fa-solid fa-chevron-right"></i>代码折叠，点击展开 </summary>
              <div class='content'>
              <div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">CameraShared::_add_device(	cStr&amp;               interfaceName,</span><br><span class="line">							GenTL::IF_HANDLE	interfaceHandle,</span><br><span class="line">							<span class="type">const</span> SiDeviceList&amp;	devices,</span><br><span class="line">							<span class="type">const</span> <span class="type">int64_t</span>&amp;		id,</span><br><span class="line">							<span class="type">int</span> &amp; nDevices)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (m_Device_inInterface_Map.<span class="built_in">count</span>(interfaceName) != <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		*m_log &lt;&lt; CustomerLog::<span class="built_in">time</span>() &lt;&lt; <span class="string">&quot;            [CameraShared::_add_device]: Error: interfaceName: &quot;</span> &lt;&lt; interfaceName &lt;&lt; <span class="string">&quot; not found!\n&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// [done]: add check to ignore the devices connected ---------------</span></span><br><span class="line">	<span class="keyword">auto</span> it = devices.<span class="built_in">begin</span>();</span><br><span class="line">	std::<span class="built_in">advance</span>(it, id);</span><br><span class="line">	<span class="keyword">auto</span> device_name = it-&gt;second;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// device: unsupported</span></span><br><span class="line">	<span class="keyword">if</span> (device_name == <span class="string">&quot;&quot;</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		*m_log &lt;&lt; CustomerLog::<span class="built_in">time</span>() &lt;&lt; <span class="string">&quot;        [CameraShared::_add_device]:     [x ] Unsupported   device: &quot;</span> &lt;&lt; it-&gt;first &lt;&lt; <span class="string">&quot; \n&quot;</span>;</span><br><span class="line">		<span class="keyword">if</span>(m_connectedDevices.<span class="built_in">count</span>(it-&gt;first) == <span class="number">0</span>)</span><br><span class="line">			m_connectedDevices.<span class="built_in">insert</span>(&#123; it-&gt;first, std::<span class="built_in">make_shared</span>&lt;DeviceConnection&gt;(it-&gt;first)&#125;);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// device: already found</span></span><br><span class="line">	<span class="keyword">if</span> (m_connectedDevices.<span class="built_in">count</span>(device_name) == <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(m_connectedDevices[device_name]-&gt;mDeviceName != <span class="string">&quot;&quot;</span>)</span><br><span class="line">		*m_log &lt;&lt; CustomerLog::<span class="built_in">time</span>() &lt;&lt; <span class="string">&quot;        [CameraShared::_add_device]:     [! ] Ignore [SICK] device: &quot;</span> &lt;&lt; device_name &lt;&lt; <span class="string">&quot;, already found! \n&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">auto</span> pDev = std::<span class="built_in">make_shared</span>&lt;DeviceConnection&gt;(	m_pconsumer,</span><br><span class="line">													interfaceHandle,</span><br><span class="line">													devices,</span><br><span class="line">													id,</span><br><span class="line">													interfaceName);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// device: occupied or unreachable</span></span><br><span class="line">	<span class="keyword">if</span> (pDev-&gt;<span class="built_in">isOccupied</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		*m_log &lt;&lt; CustomerLog::<span class="built_in">time</span>() &lt;&lt; <span class="string">&quot;        [CameraShared::_add_device]:     [! ] Error  [SICK] device: &quot;</span> &lt;&lt; device_name &lt;&lt; <span class="string">&quot;, occupied, device is busy! \n&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!pDev-&gt;<span class="built_in">isReachable</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		*m_log &lt;&lt; CustomerLog::<span class="built_in">time</span>() &lt;&lt; <span class="string">&quot;        [CameraShared::_add_device]:     [! ] Error  [SICK] device: &quot;</span> &lt;&lt; device_name &lt;&lt; <span class="string">&quot;, unreachable, device ip = &quot;</span>&lt;&lt;pDev-&gt;<span class="built_in">getIp</span>() &lt;&lt; <span class="string">&quot;, please check computer ip! \n&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// device is available</span></span><br><span class="line">	++nDevices;</span><br><span class="line">    m_connectedDevices.<span class="built_in">insert</span>(&#123;pDev-&gt;mDeviceName, pDev&#125;);</span><br><span class="line">    m_Device_inInterface_Map[interfaceName].<span class="built_in">insert</span>(pDev-&gt;mDeviceName);</span><br><span class="line">		*m_log &lt;&lt; CustomerLog::<span class="built_in">time</span>() &lt;&lt; <span class="string">&quot;        [CameraShared::_add_device]:     [ok] Add    [SICK] device: &quot;</span> &lt;&lt; pDev-&gt;mDeviceName &lt;&lt; <span class="string">&quot;, successfully! \n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
              </div>
            </details>





<h4 id="clear-invalid-device"><a href="#clear-invalid-device" class="headerlink" title="_clear_invalid_device"></a>_clear_invalid_device</h4><h5 id="声明-3"><a href="#声明-3" class="headerlink" title="声明"></a>声明</h5><div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span>        _clear_invalid_device       (cStr&amp; name);</span><br></pre></td></tr></table></figure></div>
<h5 id="描述-6"><a href="#描述-6" class="headerlink" title="描述"></a>描述</h5><p>此函数对单个设备调用，用于移除<code>name</code>对应的设备，包括其在<code>m_connectedDevices</code>，<code>m_Device_inInterface_Map</code>中的所有记录。如果某个接口下的设备都被移除完毕，还会顺便关闭这个接口</p>
<p>（这个描述是我根据SICK SDK的实现总结的，因为我认为这个SDK中这个函数实现的不太好，所以说不好是我总结的描述不符合SDK设计的意图，还是函数实现的有问题）</p>
<h5 id="内部逻辑-3"><a href="#内部逻辑-3" class="headerlink" title="内部逻辑"></a>内部逻辑</h5><ul>
<li>从<code>m_connectedDevices</code>中移除目标设备</li>
<li>对于<code>m_Device_inInterface_Map</code>中的每个条目（接口），检查当前接口<ul>
<li>①若未挂载任何SICK设备，则从<code>m_Interfaces_Map</code>，<code>m_Device_inInterface_Map</code>中移除当前接口项（我认为SDK在这步之前少了一步关闭接口，并且对于迭代器重复++了）</li>
<li>②若挂载了SICK设备，则在<code>m_Interfaces_Map</code>中接口项的设备名称集合中查找是否有目标设备，若有则将其从设备名称集合中移除。移除后再次进行①中逻辑</li>
</ul>
</li>
</ul>
<h5 id="代码-3"><a href="#代码-3" class="headerlink" title="代码"></a>代码</h5><details class="blue" data-header-exclude><summary><i class="fa-solid fa-chevron-right"></i>代码折叠，点击展开 </summary>
              <div class='content'>
              <div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 感觉此函数实现有大问题</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line">CameraShared::_clear_invalid_device(cStr&amp; name)</span><br><span class="line">&#123;</span><br><span class="line">	m_connectedDevices.<span class="built_in">erase</span>(name);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// clear device</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> devs = m_Device_inInterface_Map.<span class="built_in">begin</span>(); devs!= m_Device_inInterface_Map.<span class="built_in">end</span>();)</span><br><span class="line">    &#123;</span><br><span class="line">		*m_log &lt;&lt; CustomerLog::<span class="built_in">time</span>() &lt;&lt; <span class="string">&quot;[CameraShared::_clear_invalid_device]: Try to close device: &quot;</span> &lt;&lt; name &lt;&lt; <span class="string">&quot; in NetCad: &quot;</span> &lt;&lt; devs-&gt;first &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (devs-&gt;second.<span class="built_in">empty</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			m_Interfaces_Map.<span class="built_in">erase</span>(devs-&gt;first);</span><br><span class="line">			m_Device_inInterface_Map.<span class="built_in">erase</span>(devs++);</span><br><span class="line">			*m_log &lt;&lt; CustomerLog::<span class="built_in">time</span>() &lt;&lt; <span class="string">&quot;[CameraShared::_clear_invalid_device]: Not found device: &quot;</span> &lt;&lt; name &lt;&lt; <span class="string">&quot; in NetCad: &quot;</span> &lt;&lt; devs-&gt;first &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">			++devs;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (devs-&gt;second.<span class="built_in">count</span>(name) == <span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			devs-&gt;second.<span class="built_in">erase</span>(name);</span><br><span class="line">			*m_log &lt;&lt; CustomerLog::<span class="built_in">time</span>() &lt;&lt; <span class="string">&quot;[CameraShared::_clear_invalid_device]: Close device: &quot;</span> &lt;&lt; name &lt;&lt; <span class="string">&quot; in NetCad: &quot;</span> &lt;&lt; devs-&gt;first &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(devs-&gt;second.<span class="built_in">empty</span>())</span><br><span class="line">        &#123;</span><br><span class="line">			*m_log &lt;&lt; CustomerLog::<span class="built_in">time</span>() &lt;&lt; <span class="string">&quot;[CameraShared::_clear_invalid_device]: Interface is empty in NetCad: &quot;</span> &lt;&lt; devs-&gt;first &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __linux__</span></span><br><span class="line">            m_pconsumer-&gt;<span class="built_in">closeInterface</span>(m_Interfaces_Map[devs-&gt;first]);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _WIN32</span></span><br><span class="line">            <span class="built_in">CC</span>(m_sTl, m_sTl-&gt;<span class="built_in">IFClose</span>(m_Interfaces_Map[devs-&gt;first]));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            *m_log &lt;&lt; CustomerLog::<span class="built_in">time</span>() &lt;&lt; <span class="string">&quot;[CameraShared::_clear_invalid_device]: Close Interface: &quot;</span> &lt;&lt; devs-&gt;first &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">            m_Interfaces_Map.<span class="built_in">erase</span>(devs-&gt;first);</span><br><span class="line">            m_Device_inInterface_Map.<span class="built_in">erase</span>(devs++);</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			++devs;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
              </div>
            </details>



<h3 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h3><p>上面我们总结完了相关的成员变量和函数，现在我们重新看下问题：</p>
<ul>
<li>①设备掉线后进程崩溃</li>
<li>②修复①后，在设备断线后重连时无法正常连接，且有报错<code>GenTL call failed: -1006, Message: Requested handle not found in the pool</code></li>
</ul>
<h4 id="设备掉线后进程崩溃"><a href="#设备掉线后进程崩溃" class="headerlink" title="设备掉线后进程崩溃"></a>设备掉线后进程崩溃</h4><p>这个问题比较明显也比较好解决，原因就是SDK中访问了已释放的内存：</p>
<p>在分离运行的<code>_check_HeartBeats_run()</code>中有一个函数<code>_freeDevice()</code>，其中有：</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">m_pR3S-&gt;_clear_invalid_device(m_DeviceName);</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: CameraShared.cpp</span></span><br><span class="line"><span class="type">void</span> CameraShared::_clear_invalid_device(cStr&amp; name)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">	m_connectedDevices.<span class="built_in">erase</span>(name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> devs = m_Device_inInterface_Map.<span class="built_in">begin</span>(); devs!= m_Device_inInterface_Map.<span class="built_in">end</span>();)</span><br><span class="line">    &#123;</span><br><span class="line">		*m_log &lt;&lt; CustomerLog::<span class="built_in">time</span>() &lt;&lt; <span class="string">&quot;[CameraShared::_clear_invalid_device]: Try to close device: &quot;</span> &lt;&lt; name &lt;&lt; <span class="string">&quot; in NetCad: &quot;</span> &lt;&lt; devs-&gt;first &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (devs-&gt;second.<span class="built_in">empty</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			m_Interfaces_Map.<span class="built_in">erase</span>(devs-&gt;first);</span><br><span class="line">			m_Device_inInterface_Map.<span class="built_in">erase</span>(devs++);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 首先这个打印可能访问到已释放或者未定义的内存</span></span><br><span class="line">            <span class="comment">// 其次这devs两次++，迷惑</span></span><br><span class="line">			*m_log &lt;&lt; CustomerLog::<span class="built_in">time</span>() &lt;&lt; <span class="string">&quot;[CameraShared::_clear_invalid_device]: Not found device: &quot;</span> &lt;&lt; name &lt;&lt; <span class="string">&quot; in NetCad: &quot;</span> &lt;&lt; devs-&gt;first &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">			++devs;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>解决方法:</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: CameraShared.cpp</span></span><br><span class="line">        <span class="keyword">if</span> (devs-&gt;second.<span class="built_in">empty</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">auto</span> to_erase = devs++;</span><br><span class="line">            m_Interfaces_Map.<span class="built_in">erase</span>(to_erase-&gt;first);</span><br><span class="line">            *m_log &lt;&lt; CustomerLog::<span class="built_in">time</span>() &lt;&lt; <span class="string">&quot;&lt;&quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; <span class="string">&quot;&gt;&quot;</span> &lt;&lt; <span class="string">&quot;[CameraShared::_clear_invalid_device]: No device: &quot;</span> &lt;&lt; name &lt;&lt; <span class="string">&quot; in NetCad: &quot;</span> &lt;&lt; to_erase-&gt;first &lt;&lt; <span class="string">&quot;close now&quot;</span> &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">            m_Device_inInterface_Map.<span class="built_in">erase</span>(to_erase);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></div>


<h4 id="断线后无法正常重连"><a href="#断线后无法正常重连" class="headerlink" title="断线后无法正常重连"></a>断线后无法正常重连</h4><p>先上结论，断线时未调用<code>IFClose()</code>关闭接口，然后重连时调用<code>TLOpenInterface()</code>尝试打开未关闭的接口，导致错误。</p>
<p>分析这个问题，首先要从调用链的最开始来看，例程中的调用链大概是这样子：</p>
<div class="highlight-container" data-rel="Text"><figure class="iseeu highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">BEGIN   → CameraShared::CameraShared() → CameraShared::_scan_Device() → CameraShared::_scan_interface() → CameraShared::_add_device()</span><br><span class="line">        → Ranger3::Ranger3() → 忽略</span><br><span class="line">        → Ranger3::connectCamera(cb_on_lost)    → Ranger3::_connectCamera() → 忽略</span><br><span class="line">                                                → Ranger3::_check_HeartBeats_run()(if lost) → Ranger3::_freeDevice() → CameraShared::_clear_invalid_device()</span><br><span class="line">                                                                                            → cb_on_lost() → Ranger3::reconnectCamera() → CameraShared::_scan_Device() → 省略</span><br><span class="line">                                                                                                                                        → Ranger3::connectCamera(cb_on_lost) → 省略</span><br><span class="line">        → 忽略</span><br></pre></td></tr></table></figure></div>

<p>其中<code>cb_on_lost</code>是用户注册的回调，在相机断线时SDK会在<code>CameraShared::_freeDevice()</code>后调用此函数。本文中我参考SICK例程，在回调中循环定时调用<code>Ranger3::reconnectCamera()</code></p>
<p>然后需要关注的另一个点是，主机上都挂载了哪些GenICam设备，那么简单分为以下几类：</p>
<ul>
<li>①主机上仅挂载单个SICK设备；</li>
<li>②主机上挂载两个及以上SICK设备（不同网口）</li>
<li>③主机上挂载两个及以上SICK设备（同一网口下）</li>
<li>④主机上挂载一个SICK设备和一个非SICK设备（不同网口）</li>
<li>⑤主机上挂载一个SICK设备和一个非SICK设备（同一个网口）</li>
</ul>
<p>对于①，目测SDK内的实现没有什么大问题<br>对于②③，暂时没条件测试，暂时过，后面可能会验证。<br>现在来谈谈④：</p>
<h5 id="主机上挂载一个SICK设备和一个非SICK设备（不同网口）"><a href="#主机上挂载一个SICK设备和一个非SICK设备（不同网口）" class="headerlink" title="主机上挂载一个SICK设备和一个非SICK设备（不同网口）"></a>主机上挂载一个SICK设备和一个非SICK设备（不同网口）</h5><p>在分析之前，我先例举一下主机上连接的设备，以便后续的流程梳理。</p>
<p>主机的两个网口<code>enp3s0</code>，<code>enp4s0</code>（忽略其他网口）各挂载着一个GenICam设备：</p>
<ul>
<li><code>enp3s0</code>上挂载的是非SICK设备A</li>
<li><code>enp4s0</code>上挂载的是SICK设备B</li>
</ul>
<p>然后我们按照函数调用链开始梳理</p>
<br>

<p>在构造<code>CameraShared</code>时，会调用<a href="#scan-Device">_scan_Device()</a>，其中会对每个物理接口做一些操作，先看<code>enp3s0</code>：</p>
<ul>
<li>通过<code>openInterfaceById()</code>间接调用<code>TLOpenInterface()</code>打开<code>enp3s0</code>，并返回其句柄。</li>
<li>对其调用<code>_scan_interface()</code>。在<code>_scan_interface()</code>中，<code>enp3s0</code>被添加进<code>m_Interfaces_Map</code>和<code>m_Device_inInterface_Map</code>。</li>
<li>对<code>enp3s0</code>下每个设备调用<code>_add_device()</code>。在<code>_add_device()</code>中，由于A为非SICK设备，所以将其加入<code>m_connectedDevices</code>但不会更新<code>m_Device_inInterface_Map</code>中的设备集。</li>
<li><code>enp3s0</code>的扫描过程结束，最终结果是：<ul>
<li><code>m_Interfaces_Map</code>：<code>&#123;&#123;"enp3s0", < enp3s0的接口句柄 >&#125;&#125;</code></li>
<li><code>m_Device_inInterface_Map</code>：<code>&#123;&#123;"enp3s0", &#123;&#125;&#125;&#125;</code></li>
<li><code>m_connectedDevices</code>：<code>&#123;&#123;< A的名称 >, < DeviceConnection for A >&#125;&#125;</code></li>
</ul>
</li>
</ul>
<p>对于<code>enp4s0</code>，由于其下挂载的B是SICK设备，所以与<code>enp3s0</code>不同的是，在<code>_add_device</code>中，会将其名称加入到<code>m_Device_inInterface_Map</code>中接口对应的设备集下，因此<code>enp4s0</code>扫描过程结束后的结果是：</p>
<ul>
<li><code>m_Interfaces_Map</code>：<code>&#123;&#123;"enp3s0", < enp3s0的接口句柄 >&#125;, &#123;"enp4s0", < enp4s0的接口句柄 >&#125;&#125;</code></li>
<li><code>m_Device_inInterface_Map</code>：<code>&#123;&#123;"enp3s0", &#123;&#125;&#125;, &#123;&quot;enp4s0&quot;, &#123;&lt; B的名称 &gt;&#125;&#125;&#125;</code></li>
<li><code>m_connectedDevices</code>：<code>&#123;&#123;< A的名称 >, < DeviceConnection for A >&#125;, &#123;< B的名称 >, < DeviceConnection for B >&#125;&#125;</code></li>
</ul>
<p><code>_scan_Device()</code>还有一个需要注意的Postcondition是，所有挂载了GenICam设备的接口，都被打开了并在Producer中被管理。</p>
<br>

<p>现在我们关注，当设备断线时，会被调用的<a href="#clear-invalid-device">_clear_invalid_device()</a>，因为问题就是出现在这里。注意！！！只有SICK设备才会调用到这个函数。所以对于B：</p>
<ul>
<li>从<code>m_connectedDevices</code>中移除B对应的元素</li>
<li>对于<code>m_Device_inInterface_Map</code>中的每个接口：<ul>
<li>首先是<code>enp3s0</code>，由于其下的设备集合为空，因此在<code>m_Interfaces_Map</code>和<code>m_Device_inInterface_Map</code>中删除相关项。注意！！！问题出现在这里，这里并没有调用<code>IFClose</code>关闭接口，导致接口在Producer中没释放。</li>
<li>然后是<code>enp4s0</code>，其下挂载了B，首先删除<code>m_Device_inInterface_Map</code>中<code>enp4s0</code>对应的设备集合中B的相关元素，然后调用<code>IFClose</code>关闭接口，最后在<code>m_Interfaces_Map</code>和<code>m_Device_inInterface_Map</code>中删除相关项</li>
</ul>
</li>
<li>至此B设备的清理完成，最终的结果：<ul>
<li><code>m_Interfaces_Map</code>：<code>&#123;&#125;</code></li>
<li><code>m_Device_inInterface_Map</code>：<code>&#123;&#125;</code></li>
<li><code>m_connectedDevices</code>：<code>&#123;&#123;< A的名称 >, < DeviceConnection for A >&#125;&#125;</code></li>
</ul>
</li>
</ul>
<p>这里的问题是没有调用<code>IFClose</code>关闭接口<code>enp3s0</code>，但是清除了其在Consumer中的相关记录，这就会导致Consumer这边认为<code>enp3s0</code>已关闭，而实际上Producer中可能仍管理着这个接口（具体取决于Producer实现，俺不知道）。然后在后续的<code>reconnectCamera()</code>调用中会再次调用到<code>_scan_interface()</code>，会有报错：</p>
<div class="highlight-container" data-rel="Text"><figure class="iseeu highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GenTL call failed: -1006, Message: Requested handle not found in the pool</span><br></pre></td></tr></table></figure></div>

<p>排查一下，上述报错是<code>_scan_Device()</code>中第一个用宏<code>CR</code>修饰的涉及<code>enp3s0</code>接口的GenTL调用报出的，即</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CR</span>(mTl-&gt;<span class="built_in">IFUpdateDeviceList</span>(ifHandle, &amp;changed, <span class="number">500</span>));</span><br></pre></td></tr></table></figure></div>

<p>但仔细分析，其实这不是源头，因为<code>_scan_Device()</code>中的第一个涉及<code>enp3s0</code>接口的GenTL调用并不是<code>IFUpdateDeviceList()</code>，而是<code>TLOpenInterface()</code>，只不过其没有使用<code>CR</code>修饰，因此不会抛出异常和打印报错信息。现在为了测试，我们为其添加<code>CR</code>：</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: Consumer.cpp</span></span><br><span class="line"><span class="function">GenTL::IF_HANDLE <span class="title">Consumer::openInterfaceById</span><span class="params">(<span class="type">const</span> InterfaceId&amp; interfaceId)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="built_in">CR</span>(mTl-&gt;<span class="built_in">TLOpenInterface</span>(mTlHandle, interfaceId.<span class="built_in">c_str</span>(), &amp;interfaceHandle));</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>然后报错会变为：</p>
<div class="highlight-container" data-rel="Text"><figure class="iseeu highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GenTL call failed: -1005, Message: ItfOpen: the requested interface exists in the list, but is marked as inaccessible</span><br></pre></td></tr></table></figure></div>

<p>可以看出这里打开接口是失败了的，错误码<code>-1005 GC_ERR_ACCESS_DENIED</code>，因此接口句柄无效，所以在<code>IFUpdateDeviceList</code>才会报出<code>-1006 GC_ERR_INVALID_HANDLE</code>错误码。</p>
<p>初步的解决措施是在<code>_clear_invalid_device()</code>中对未挂载设备的接口增加一个调用<code>closeInterface()</code>，手动关闭接口即可。（其实<code>_clear_invalid_device()</code>大逻辑还是可以优化的，但还是等要到SDK最新版本看一下官方的解决方案吧）</p>
<h5 id="主机上挂载一个SICK设备和一个非SICK设备（相同网口）"><a href="#主机上挂载一个SICK设备和一个非SICK设备（相同网口）" class="headerlink" title="主机上挂载一个SICK设备和一个非SICK设备（相同网口）"></a>主机上挂载一个SICK设备和一个非SICK设备（相同网口）</h5><p>暂略，未做实验验证</p>
<h2 id="声明错误"><a href="#声明错误" class="headerlink" title="声明错误"></a>声明错误</h2><h3 id="m-Interfaces-Map-1"><a href="#m-Interfaces-Map-1" class="headerlink" title="m_Interfaces_Map"></a>m_Interfaces_Map</h3><div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: CameraShared.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 接口句柄映射</span></span><br><span class="line"><span class="type">static</span> std::map&lt;std::string, GenTL::TL_HANDLE&gt; m_Interfaces_Map;</span><br></pre></td></tr></table></figure></div>

<p>这个结构体应该是接口名称到接口句柄的映射表，用于记录和管理当前已打开的接口（对于GigE就是网口）。在GenTL中对应的句柄应该是<code>GenTL::IF_HANDLE</code>，所以此变量的声明理应改为：</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: CameraShared.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 接口句柄映射</span></span><br><span class="line"><span class="type">static</span> std::map&lt;std::string, GenTL::IF_HANDLE&gt; m_Interfaces_Map;</span><br></pre></td></tr></table></figure></div>

<p>只不过由于：</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: GenTL.h</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">void</span> *  TL_HANDLE;         <span class="comment">/* Transport Layer handle, obtained through the TLOpen */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">void</span> *  IF_HANDLE;         <span class="comment">/* Interface handle, obtained through ::TLOpenInterface */</span></span><br></pre></td></tr></table></figure></div>

<p>并且实际使用中向<code>m_Interfaces_Map</code>传入的都是<code>GenTL::IF_HANDLE</code>，因此代码实际上并不会出现什么错误。</p>
<p>上述结论也可以通过SDK中其他与<code>m_Interfaces_Map</code>相关的调用来验证。</p>
<h3 id="interfaceHandle"><a href="#interfaceHandle" class="headerlink" title="interfaceHandle"></a>interfaceHandle</h3><p>错误原因与<a href="#m-Interfaces-Map-1">m_Interfaces_Map</a>相同：</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: CameraShared.cpp</span></span><br><span class="line"></span><br><span class="line">CAM_STATUS</span><br><span class="line">CameraShared::_scan_Device(<span class="type">int</span>&amp; numberDeviceNewFound)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; interfaces.<span class="built_in">size</span>(); ++i)</span><br><span class="line">	&#123;</span><br><span class="line">        ...</span><br><span class="line">        GenTL::TL_HANDLE interfaceHandle = GENTL_INVALID_HANDLE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>应改为</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: CameraShared.cpp</span></span><br><span class="line"></span><br><span class="line">CAM_STATUS</span><br><span class="line">CameraShared::_scan_Device(<span class="type">int</span>&amp; numberDeviceNewFound)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; interfaces.<span class="built_in">size</span>(); ++i)</span><br><span class="line">	&#123;</span><br><span class="line">        ...</span><br><span class="line">        GenTL::IF_HANDLE interfaceHandle = GENTL_INVALID_HANDLE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
        </div>

        
            <div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
                <div class="article-copyright-info-container">
    <ul>
        <li><strong>标题:</strong> SICK Ranger3源码分析——断线重连</li>
        <li><strong>作者:</strong> paw5zx</li>
        <li><strong>创建于
                :</strong> 2025-03-09 00:19:32</li>
        
            <li>
                <strong>更新于
                    :</strong> 2025-05-26 11:16:38
            </li>
        
        <li>
            <strong>链接:</strong> https://paw5zx.github.io/SICK-Ranger3-source-code-analysis-01/
        </li>
        <li>
            <strong>
                版权声明:
            </strong>
            

            
                本文章采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a> 进行许可。
            
        </li>
    </ul>
</div>

            </div>
        

        

        
  <div class="recommended-article px-2 sm:px-6 md:px-8">
   <div class="recommended-desktop">
    <div class="recommended-article-header text-xl md:text-3xl font-bold mt-10">
     <i aria-hidden="true"></i><span>推荐阅读</span>
    </div>
    <div class="recommended-article-group"><a class="recommended-article-item" href="/thirdlib-log4cpp/" title="log4cpp的安装及使用" rel="bookmark">
  <img src="/images/wallhaven-wqery6-light.webp" alt="log4cpp的安装及使用" class="!max-w-none">
  <span class="title">log4cpp的安装及使用</span>
</a><a class="recommended-article-item" href="/pylon-cpp-advanced-topics/" title="Pylon C++ Advanced Topics" rel="bookmark">
  <img src="/images/wallhaven-wqery6-light.webp" alt="Pylon C++ Advanced Topics" class="!max-w-none">
  <span class="title">Pylon C++ Advanced Topics</span>
</a><a class="recommended-article-item" href="/SICK-Ranger3-source-code-analysis-02/" title="SICK Ranger3源码分析——GenTL API封装" rel="bookmark">
  <img src="/images/wallhaven-wqery6-light.webp" alt="SICK Ranger3源码分析——GenTL API封装" class="!max-w-none">
  <span class="title">SICK Ranger3源码分析——GenTL API封装</span>
</a></div>
   </div>
   <div class="recommended-mobile">
   <div class="recommended-article-header text-xl md:text-3xl font-bold mt-10">
     <i aria-hidden="true"></i><span>推荐阅读</span>
   </div>
   <div class="recommended-article-group"><a class="recommended-article-item" href="/thirdlib-log4cpp/" title="log4cpp的安装及使用" rel="bookmark">
  <img src="/images/wallhaven-wqery6-light.webp" alt="log4cpp的安装及使用" class="!max-w-none">
  <span class="title">log4cpp的安装及使用</span>
</a><a class="recommended-article-item" href="/pylon-cpp-advanced-topics/" title="Pylon C++ Advanced Topics" rel="bookmark">
  <img src="/images/wallhaven-wqery6-light.webp" alt="Pylon C++ Advanced Topics" class="!max-w-none">
  <span class="title">Pylon C++ Advanced Topics</span>
</a></div>
   </div>
  </div>

        
            <div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
                
                    <div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="prev"
                        rel="prev"
                        href="/SICK-Ranger3-source-code-analysis-02/"
                        >
                            <span class="left arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-left"></i>
                            </span>
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">SICK Ranger3源码分析——GenTL API封装</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="next"
                        rel="next"
                        href="/rust-common-concepts-3/"
                        >
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">Rust基础学习（三）——控制流</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                            <span class="right arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        


        
            <div class="comment-container px-2 sm:px-6 md:px-8 pb-8">
                <div class="comments-container mt-10 w-full ">
    <div id="comment-anchor" class="w-full h-2.5"></div>
    <div class="comment-area-title w-full my-1.5 md:my-2.5 text-xl md:text-3xl font-bold">
        评论
    </div>
    

        
            
    <div id="giscus-container"></div>
    <script data-swup-reload-script defer>
        async function loadGiscus() {
            const giscusConfig = {
                'src': 'https://giscus.app/client.js',
                'data-repo': 'paw5zx/Blog-discussion',
                'data-repo-id': 'R_kgDOMnAVmg',
                'data-category': 'Announcements',
                'data-category-id': 'DIC_kwDOMnAVms4Ch3WS',
                'data-mapping': 'pathname',
                'data-strict': '1',
                'data-reactions-enabled': '1',
                'data-emit-metadata': '1',
                'data-theme': 'preferred_color_scheme',
                'data-lang': 'zh-CN',
                'data-input-position': 'bottom',
                'data-loading': 'lazy',
                'crossorigin': 'anonymous',
                'async': true
            }
            const giscusScript = document.createElement('script');
            for (const key in giscusConfig) {
                giscusScript.setAttribute(key, giscusConfig[key]);
            }
            document.getElementById('giscus-container').appendChild(giscusScript);
        }
        if ('true') {
            let loadGiscusTimeout = setTimeout(() => {
                loadGiscus();
                clearTimeout(loadGiscusTimeout);
            }, 1000);
        } else {
            document.addEventListener('DOMContentLoaded', loadGiscus);
        }
    </script>


        
        
    
</div>

            </div>
        
    </div>

    
        <div class="toc-content-container">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">目录</div>
        <div class="page-title">SICK Ranger3源码分析——断线重连</div>
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%96%AD%E7%BA%BF%E6%A3%80%E6%B5%8B"><span class="nav-text">断线检测</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%96%AD%E7%BA%BF%E9%80%9A%E7%9F%A5"><span class="nav-text">断线通知</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%87%8D%E8%BF%9E%E5%AE%9E%E7%8E%B0"><span class="nav-text">重连实现</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-text">遇到的问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%87%8D%E8%BF%9E%E6%97%B6%E5%A4%B1%E8%B4%A5"><span class="nav-text">重连时失败</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F"><span class="nav-text">成员变量</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#m-connectedDevices"><span class="nav-text">m_connectedDevices</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#m-Interfaces-Map"><span class="nav-text">m_Interfaces_Map</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#m-Device-inInterface-Map"><span class="nav-text">m_Device_inInterface_Map</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%BD%E6%95%B0"><span class="nav-text">函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#scan-Device"><span class="nav-text">_scan_Device</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#scan-interface"><span class="nav-text">_scan_interface</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#add-device"><span class="nav-text">_add_device</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#clear-invalid-device"><span class="nav-text">_clear_invalid_device</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="nav-text">问题分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E5%A4%87%E6%8E%89%E7%BA%BF%E5%90%8E%E8%BF%9B%E7%A8%8B%E5%B4%A9%E6%BA%83"><span class="nav-text">设备掉线后进程崩溃</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%AD%E7%BA%BF%E5%90%8E%E6%97%A0%E6%B3%95%E6%AD%A3%E5%B8%B8%E9%87%8D%E8%BF%9E"><span class="nav-text">断线后无法正常重连</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A3%B0%E6%98%8E%E9%94%99%E8%AF%AF"><span class="nav-text">声明错误</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#m-Interfaces-Map-1"><span class="nav-text">m_Interfaces_Map</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#interfaceHandle"><span class="nav-text">interfaceHandle</span></a></li></ol></li></ol></li></ol>

    </div>
</div>
        </div>
    
</div>



                

            </div>

            

        </div>

        <div class="main-content-footer">
            <footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2024</span>
              -
            
            2025&nbsp;&nbsp;<i class="fa-solid fa-poo-bolt fa-beat-fade" style="--fa-beat-fade-opacity: 0.8; --fa-beat-fade-scale: 1.00;"></i>&nbsp;&nbsp;<a href="/">paw5zx</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        共撰写了 53 篇文章
                    </span>
                    
                        <span>
                            共 109.8k 字
                        </span>
                    
                </p>
            
        </div>
        
            <script data-swup-reload-script src="https://cn.vercount.one/js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                    <span id="busuanzi_container_site_uv" class="lg:!block">
                        <span class="text-sm">访问人数</span>
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="lg:!block">
                        <span class="text-sm">总访问量</span>
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">由 <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a> 驱动</span>
            <span class="text-sm lg:block">主题&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.7.2</a></span>
        </div>
        
        
            <div>
                博客已运行 <span class="odometer" id="runtime_days" ></span> 天 <span class="odometer" id="runtime_hours"></span> 小时 <span class="odometer" id="runtime_minutes"></span> 分钟 <span class="odometer" id="runtime_seconds"></span> 秒
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fa-regular fa-comments"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fa-solid fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="站内搜索您需要的内容..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fa-solid fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>


    
<script src="/js/libs/Swup.min.js"></script>

<script src="/js/libs/SwupSlideTheme.min.js"></script>

<script src="/js/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>







<script src="/js/tools/imageViewer.js" type="module"></script>

<script src="/js/utils.js" type="module"></script>

<script src="/js/main.js" type="module"></script>

<script src="/js/layouts/navbarShrink.js" type="module"></script>

<script src="/js/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/layouts/categoryList.js" type="module"></script>



    
<script src="/js/tools/localSearch.js" type="module"></script>




    
<script src="/js/tools/codeBlock.js" type="module"></script>




    
<script src="/js/layouts/lazyload.js" type="module"></script>




    
<script src="/js/tools/runtime.js"></script>

    
<script src="/js/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js" type="module"></script>











    
<script src="/js/tools/tocToggle.js" type="module" data-swup-reload-script=""></script>

<script src="/js/layouts/toc.js" type="module" data-swup-reload-script=""></script>

<script src="/js/plugins/tabs.js" type="module" data-swup-reload-script=""></script>




<script src="/js/libs/moment-with-locales.min.js" data-swup-reload-script=""></script>


<script src="/js/layouts/essays.js" type="module" data-swup-reload-script=""></script>




</body>
</html>
